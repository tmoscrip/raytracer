<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 20px;
        height: 100vh;
        margin: 0;
        background-color: #111;
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      canvas {
        border: 1px solid #333;
      }
      .controls {
        background-color: #222;
        padding: 20px;
        border-radius: 8px;
        color: #fff;
        min-width: 300px;
      }
      .control-group {
        margin-bottom: 20px;
      }
      .control-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .control-group input {
        width: 100%;
        padding: 5px;
        margin-bottom: 5px;
        background-color: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 3px;
      }
      .control-group button {
        background-color: #555;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
      }
      .control-group button:hover {
        background-color: #666;
      }
      .coordinate-inputs {
        display: flex;
        gap: 10px;
      }
      .coordinate-inputs input {
        flex: 1;
      }
      .coordinate-inputs label {
        text-align: center;
        font-size: 12px;
        margin-bottom: 2px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="200" height="200"></canvas>

    <div class="controls">
      <h3>Raytracer Controls</h3>

      <div class="control-group">
        <label>Light Position</label>
        <div class="coordinate-inputs">
          <div>
            <label>X</label>
            <input type="number" id="lightX" value="15" step="0.1" />
          </div>
          <div>
            <label>Y</label>
            <input type="number" id="lightY" value="5" step="0.1" />
          </div>
          <div>
            <label>Z</label>
            <input type="number" id="lightZ" value="-10" step="0.1" />
          </div>
        </div>
      </div>

      <div class="control-group">
        <label>Sphere Position</label>
        <div class="coordinate-inputs">
          <div>
            <label>X</label>
            <input type="number" id="sphereX" value="0" step="0.1" />
          </div>
          <div>
            <label>Y</label>
            <input type="number" id="sphereY" value="0" step="0.1" />
          </div>
          <div>
            <label>Z</label>
            <input type="number" id="sphereZ" value="0" step="0.1" />
          </div>
        </div>
      </div>
    </div>

    <script src="./pkg/raytracer.js"></script>
    <script>
      async function main() {
        const exports = await wasm_bindgen();
        const { RenderContext } = wasm_bindgen;
        const { memory } = exports;

        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const scene = new RenderContext(canvas.width, canvas.height);
        const buffer_size = canvas.width * canvas.height * 4;
        let lastTime = 0;
        let lastRenderTime = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS; // ~16.67ms for 60 FPS

        // Get input elements
        const lightXInput = document.getElementById("lightX");
        const lightYInput = document.getElementById("lightY");
        const lightZInput = document.getElementById("lightZ");
        const sphereXInput = document.getElementById("sphereX");
        const sphereYInput = document.getElementById("sphereY");
        const sphereZInput = document.getElementById("sphereZ");

        function renderLoop(currentTime) {
          const deltaTime = (currentTime - lastTime) / 1000.0;
          const timeSinceLastRender = currentTime - lastRenderTime;

          // Only render if enough time has passed (frame limiting)
          if (timeSinceLastRender >= frameInterval) {
            lastTime = currentTime;
            lastRenderTime = currentTime;

            // Get current input values
            const lightX = parseFloat(lightXInput.value);
            const lightY = parseFloat(lightYInput.value);
            const lightZ = parseFloat(lightZInput.value);
            const sphereX = parseFloat(sphereXInput.value);
            const sphereY = parseFloat(sphereYInput.value);
            const sphereZ = parseFloat(sphereZInput.value);

            // Update scene parameters and render
            scene.update_light_position(lightX, lightY, lightZ);
            scene.update_sphere_position(sphereX, sphereY, sphereZ);
            scene.render(deltaTime);

            const pointer = scene.get_image_buffer_pointer();
            const imageDataArray = new Uint8ClampedArray(
              memory.buffer,
              pointer,
              buffer_size
            );

            const imageData = new ImageData(
              imageDataArray,
              canvas.width,
              canvas.height
            );
            ctx.putImageData(imageData, 0, 0);
          }

          requestAnimationFrame(renderLoop);
        }

        requestAnimationFrame(renderLoop);
      }
      main();
    </script>
  </body>
</html>
